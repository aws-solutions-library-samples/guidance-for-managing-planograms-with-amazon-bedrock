document.addEventListener('DOMContentLoaded', function() {
    // setInterval(checkSession, 300000);  // Check every 5 minutes
    const form = document.getElementById('uploadForm');
    const resultsDiv = document.getElementById('results');
    const planogramImage = document.getElementById('planogram-image');
    const planogramResults = document.getElementById('planogramResults');
    const sliderImage = document.getElementById('slider-image');
    const sliderLabel = document.getElementById('slider-label');
    const prevButton = document.getElementById('prev-button');
    const nextButton = document.getElementById('next-button');

    let currentImageIndex = 0;
    let images = [];

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        document.getElementById('overlay').style.display = 'block';
        fetch('/check_planogram', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                document.getElementById('overlay').style.display = 'none';
            } else {
                images = [
                    { src: data.planogram, label: 'Planogram' },
                    { src: data.current_shelf, label: 'Current Shelf' },
                    { src: data.misplaced_items, label: 'Misplaced Items' }
                ];
                console.log(images);
                currentImageIndex = 0;
                updateSlider();
                resultsDiv.style.display = 'block';
                document.getElementById('overlay').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
            document.getElementById('overlay').style.display = 'none';
        });
    });
    document.getElementById('generatePlanogram').addEventListener('click', generatePlanogram);
    function generatePlanogram() {
        document.getElementById('overlay').style.display = 'block';
        instructions = document.getElementById('instructions').value;
        checkedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        checkedValues = Array.from(checkedCheckboxes).map(checkbox => checkbox.value);
        selectedRules = `${checkedValues.join('~')}`;
        selectedLlm = document.getElementById('llmList').value;
        const dropdown = document.getElementById("llmList");
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        selectedLabel = selectedOption.text;
        if (selectedLabel == 'Please select'){
            selectedLabel = 'Claude 3 Haiku';
        }
        // alert(selectedLabel)
        fetch('/generate_planogram', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({instructions: instructions, selectedRules: selectedRules, selectedLlm: selectedLlm})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('overlay').style.display = 'none';
                alert(data.error);
            } else {
                // alert(data.explanations)
                bulletItem = document.getElementById('explanations');
                if (data.explanations != null){
                    explanations = data.explanations;
                    explanations.forEach(item => {
                        liElement = document.createElement('li');
                        liElement.textContent = item;
                        bulletItem.appendChild(liElement);
                    });
                    document.getElementById('lblExplanation').textContent = 'Explanation generated by ' + selectedLabel + ':';
                }else{
                    liElement = document.createElement('li');
                    liElement.textContent = 'No Explanation was generated or were required';
                    bulletItem.appendChild(liElement);
                    // document.getElementById('explanations').textContent = 'No Explanation was generated or were required';
                }
                planogramImage.src = data.planogram_image;
                planogramResults.style.display = 'block';
                document.getElementById('overlay').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
            document.getElementById('overlay').style.display = 'none';
        });
    }

    function updateSlider() {
        sliderImage.src = images[currentImageIndex].src;
        sliderLabel.textContent = images[currentImageIndex].label;
    }

    prevButton.addEventListener('click', function() {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        updateSlider();
    });

    nextButton.addEventListener('click', function() {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateSlider();
    });
    function showDemoShelfs(){
        planogram_name = document.getElementById('planogram').value;
        
        if (planogram_name == '' || planogram_name.length == 0){
            document.getElementById('shelf_example').style.display = 'none';
            return;
        }

        fetch('/fetch_shelf_images', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({planogramName: planogram_name})
        })
        .then(response => response.json())
        .then(data => {
            select = document.getElementById('shelfImage');
            select.textContent = '';
            for (let i = 0; i < data.length; i++) {
                newOption = document.createElement('option');
                newOption.text = data[i]['shelfLabel'];
                newOption.value = data[i]['shelfImageLocation'];
                select.appendChild(newOption);
            }
            document.getElementById('shelf_example').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
            document.getElementById('overlay').style.display = 'none';
        });
    }
    document.getElementById('planogram').addEventListener('change', showDemoShelfs);
    document.getElementById('planogram').addEventListener('click', showDemoShelfs);
    document.getElementById('file').addEventListener('click', function() {
        document.getElementById('shelfImage').value = '';
        document.getElementById('shelf_example').style.display = 'none';
    });
    
    // function checkSession() {
    //     fetch('/check_session')
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.session_active === 'false') {
    //                 alert('Your session has expired. Please log in again.');
    //                 // Redirect to login page or perform other actions
    //                 window.location.href = '/';
    //             }
    //         })
    //         .catch(error => {
    //             console.error('Error checking session:', error);
    //         });
    // }
});
